---
  title: "R package GSMC: a simulation-free group sequential design with max-combo tests in the presence of non-proportional hazards"
  author: "[Lili Wang](https://lilywang.info)"
  date: "`r Sys.Date()`"
  output: github_document
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(collapse = TRUE,
                     comment = "#>",
                     fig.width=12, fig.height=8,
                     fig.path = "man/figures/README-")

```

## Purpose

This R package is to implement the proposed [simulation-free method for group sequential design with maxcombo tests](https://arxiv.org/abs/1911.05684 "Hey, direct me to the paper!")(GS-MC). The goal here is to improve the detection power of the weighted log-rank tests (WLRTs) when the non-proportional hazards are present. Moreover, the method is simulation-free, and allows multiple checks (interims) before ending the study. 

This R package is currently dependent on other R packages including [mvtnorm][3] and my another package on github [IAfrac][1]. I hope that this package will be improved gradually please let us know your feedback. 

For details about the calculation of the information and covariance using estimation (data-driven) and prediction methods please find the README file of [IAfrac][1]. 



## Preparation

To install and use this R package from Github, you will need to install another R package "devtools" and two packages on Github: [nphsim][2], [IAfrac][1]. Please uncomment the codes to install them. 

```{r installation, results = "hide",message=FALSE}
# install.packages("devtools")
# library(devtools)
# install.packages("gsDesign")
library(gsDesign) 

# Generate data following nonproportional hazards
# install_github("keaven/nphsim")
library(nphsim) 

# Information and covariance calculation; sample size computation using the Hasegawa proposal
# install_github("lilywang1988/GSMC")
library(GSMC) 

```

## Three different scenarios

1. Max-combo with interim stages (group sequential design)
2. Max-combo without interim stages (not a group sequential design)
3. One weighted log-rank test with interim stages (group sequential design)
4. One weighted log-rank test without interim stages (not a group sequential design)


## Sample size and threshold prediction for three tests and 3 stages (2 interim + 1 final)

```{r prediction}
### Parameters
FHweights <- list(
  c(0,0),
  c(0,1),
  c(1,0)
)
n_FHweights <- length(FHweights)

# stop when what proportion of the events have been observed.
fixed_death_p <-  c(0.6, 0.7, 0.8)
interim_ratio <- c(fixed_death_p,1)
n_stage <- length(interim_ratio)

# treatment assignment.
p <- 1/2 
# end of the study, chronological assuming it's on the alternative arm.
tau <- 18
# end of the accrual period, chronological.
R <- 14 
# minimum potential follow-up time, not considering dropouts or other subject-specific censoring.
omega <- (tau-R) 
# waiting time before the change point: can be the delayed effect or the crossing effect
eps <- 2
# event hazard of the control arm.
lambda <- log(2)/6 
# hazard ratio after the change point eps under the alternative hypothesis. 
theta <- 0.6 
# event hazard for the treatment arm under the alternative hypothesis and after the change point eps.
lambda.trt <- lambda*theta  
# type I error under the control.
alpha <- 0.025 
# type II error under the alternative. 
beta <- 0.1 

# Obtain the cumulative errors spent at each stage
x <- gsDesign(
  k = n_stage, 
  test.type = 1, 
  timing = interim_ratio[-n_stage], 
  sfu = "OF", 
  alpha = alpha, 
  beta = beta, 
  delta = -log(theta)
)
# obtain the cumulative errors spent at each stage
error_spend <- cumsum(x$upper$prob[,1])
# correct the last entry
error_spend[length(error_spend)] <- alpha 


# number of subintervals for a time unit
b <- 30
c = exp(-lambda*(1-theta)*eps) # the c constant for piece-wise exponential hazard and survival curves calculation
### Tests

### Pause at proportions

res <- GSMC_design(
  FHweights,
  interim_ratio,
  error_spend,
  eps, 
  p, 
  b, 
  tau, 
  omega,
  lambda,
  lambda.trt,
  rho, 
  gamma,
  beta,
  stoch = F
)

```



### Sample size and threshold prediction for max-combo tests without interim analysis



### Sample size and threshold computation for weighted log-rank tests without interim analysis







## References
1. Lakatos, E. (1988). Sample sizes based on the log-rank statistic in complex clinical trials. Biometrics, 229-241.

2. Hasegawa, T. (2014). Sample size determination for the weighted log‐rank test with the Fleming–Harrington class of weights in cancer vaccine studies. Pharmaceutical statistics, 13(2), 128-135.

3. Hasegawa, T. (2016). Group sequential monitoring based on the weighted log‐rank test statistic with the Fleming–Harrington class of weights in cancer vaccine studies. Pharmaceutical statistics, 15(5), 412-419.

4. Luo, X., Mao, X., Chen, X., Qiu, J., Bai, S., & Quan, H. (2019). Design and monitoring of survival trials in complex scenarios. Statistics in medicine, 38(2), 192-209.

5. Wang, L., Luo, X., & Zheng, C. (2021). A Simulation-free Group Sequential Design with Max-combo Tests in the Presence of Non-proportional Hazards. Journal of Pharmaceutical Statistics.

Dependent R packages:

[1]: https://github.com/lilywang1988/IAfrac 
[2]: https://github.com/keaven/nphsim
[3]: https://cran.r-project.org/web/packages/mvtnorm/index.html
